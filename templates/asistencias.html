{% extends "base.html" %}
{% block title %}Asistencias - Asistencia QR{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h3>Reporte de Asistencias</h3>
  <div>
    <a href="{{ url_for('generar_reporte_excel', clase_id=clase_id or '', fecha_desde=fecha_desde or '', fecha_hasta=fecha_hasta or '') }}" 
       class="btn btn-success">
      ðŸ“Š Descargar Excel
    </a>
  </div>
</div>

<!-- Filtros -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">Filtros</h5>
  </div>
  <div class="card-body">
    <form method="get" action="{{ url_for('ver_asistencias') }}" class="row g-3">
      <div class="col-md-4">
        <label for="clase_id" class="form-label">Materia</label>
        <select class="form-select" id="clase_id" name="clase_id">
          <option value="">Todas las materias</option>
          {% for c in clases %}
          <option value="{{ c.id }}" {% if clase_id == c.id %}selected{% endif %}>
            {{ c.nombre_clase }} ({{ c.codigo_clase }})
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label for="fecha_desde" class="form-label">Fecha desde</label>
        <input type="date" class="form-control" id="fecha_desde" name="fecha_desde" value="{{ fecha_desde }}">
      </div>
      <div class="col-md-3">
        <label for="fecha_hasta" class="form-label">Fecha hasta</label>
        <input type="date" class="form-control" id="fecha_hasta" name="fecha_hasta" value="{{ fecha_hasta }}">
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Filtrar</button>
      </div>
    </form>
    {% if clase_id or fecha_desde or fecha_hasta %}
    <div class="mt-2">
      <a href="{{ url_for('ver_asistencias') }}" class="btn btn-sm btn-outline-secondary">Limpiar filtros</a>
    </div>
    {% endif %}
  </div>
</div>

<!-- Resumen -->
<div class="alert alert-info">
  <strong>Total de asistencias:</strong> {{ rows|length }}
  {% if clase_id %}
    {% for c in clases %}
      {% if c.id == clase_id %}
        | <strong>Materia:</strong> {{ c.nombre_clase }}
      {% endif %}
    {% endfor %}
  {% endif %}
</div>

<!-- Tabla de asistencias -->
<div class="table-responsive">
  <table class="table table-striped table-hover">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Fecha</th>
        <th>Hora</th>
        <th>Estudiante</th>
        <th>NÃºmero de Control</th>
        <th>Materia</th>
        <th>CÃ³digo</th>
        <th>MÃ©todo</th>
      </tr>
    </thead>
    <tbody>
      {% if rows %}
        {% for a, e, c in rows %}
        <tr>
          <td>{{ a.id }}</td>
          <td>{{ a.fecha.strftime('%d/%m/%Y') }}</td>
          <td>{{ a.hora.strftime('%H:%M:%S') }}</td>
          <td>
            <strong>{{ e.nombre }}</strong>
            {% if e.correo %}
            <br><small class="text-muted">{{ e.correo }}</small>
            {% endif %}
          </td>
          <td>{{ e.numero_control }}</td>
          <td>{{ c.nombre_clase }}</td>
          <td><small>{{ c.codigo_clase }}</small></td>
          <td><span class="badge bg-success">{{ a.metodo }}</span></td>
        </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="8" class="text-center text-muted">
            No hay asistencias registradas con los filtros seleccionados.
          </td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

{% if rows|length > 0 %}
<div class="mt-3">
  <small class="text-muted">
    Mostrando {{ rows|length }} registro(s). 
    <a href="{{ url_for('generar_reporte_excel', clase_id=clase_id or '', fecha_desde=fecha_desde or '', fecha_hasta=fecha_hasta or '') }}">
      Descarga el reporte completo en Excel
    </a> para ver todos los detalles.
  </small>
</div>
{% endif %}
{% endblock %}
