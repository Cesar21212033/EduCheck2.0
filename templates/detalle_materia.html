{% extends "base.html" %}
{% block title %}{{ clase.nombre_clase }} - Asistencia QR{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3>{{ clase.nombre_clase }}</h3>
    <p class="text-muted mb-0">Código: {{ clase.codigo_clase }}</p>
  </div>
  <div>
    {% if session.get('rol') == 'admin' %}
    <a href="{{ url_for('editar_horarios', clase_id=clase.id) }}" class="btn btn-outline-info">
      <i class="bi bi-clock"></i> Editar Horarios
    </a>
    {% endif %}
    <button 
      type="button" 
      class="btn btn-success" 
      id="btnEscanearQR"
      data-bs-toggle="modal" 
      data-bs-target="#scannerModal"
      {% if not puede_registrar %}disabled title="{{ motivo_bloqueo }}"{% endif %}
    >
      <i class="bi bi-qr-code-scan"></i> Escanear QR
    </button>
    {% if not puede_registrar %}
    <small class="d-block text-danger mt-1" style="font-size: 0.85em;">
      <i class="bi bi-exclamation-circle"></i> {{ motivo_bloqueo }}
    </small>
    {% endif %}
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Volver</a>
  </div>
</div>

<!-- Mostrar horarios de la materia -->
<div class="card mb-3">
  <div class="card-header {% if horarios %}bg-info{% else %}bg-warning{% endif %} text-white">
    <h5 class="mb-0"><i class="bi bi-clock"></i> Horarios de la Materia</h5>
  </div>
  <div class="card-body">
    {% if horarios %}
    <div class="row">
      {% set dias_nombres = {1: 'Lunes', 2: 'Martes', 3: 'Miércoles', 4: 'Jueves', 5: 'Viernes'} %}
      {% for horario in horarios %}
      <div class="col-md-6 mb-2">
        <strong><i class="bi bi-calendar-day"></i> {{ dias_nombres[horario.dia_semana] }}:</strong> 
        <span class="badge bg-primary">{{ horario.hora_inicio.strftime('%H:%M') }} - {{ horario.hora_fin.strftime('%H:%M') }}</span>
      </div>
      {% endfor %}
    </div>
    {% if horario_hoy %}
    <hr>
    <div class="alert alert-success mb-0">
      <i class="bi bi-info-circle"></i> <strong>Horario de clase:</strong> 
      {{ horario_hoy.hora_inicio.strftime('%H:%M') }} - {{ horario_hoy.hora_fin.strftime('%H:%M') }}
      <br>
      <i class="bi bi-clock-history"></i> <strong>Pase de lista:</strong> 
      {% if hora_minima_pase and hora_maxima_pase %}
      {{ hora_minima_pase.strftime('%H:%M') }} - {{ hora_maxima_pase.strftime('%H:%M') }}
      {% else %}
      {{ horario_hoy.hora_inicio.strftime('%H:%M') }} - {{ horario_hoy.hora_fin.strftime('%H:%M') }}
      {% endif %}
      <small class="text-muted d-block mt-1">El pase de lista está disponible desde 15 minutos antes del inicio hasta 5 minutos después del inicio de clase.</small>
    </div>
    {% endif %}
    {% else %}
    <div class="alert alert-warning mb-0">
      <i class="bi bi-exclamation-triangle"></i> <strong>No hay horarios asignados</strong>
      <p class="mb-0 mt-2">
        Esta materia no tiene horarios configurados. 
        {% if session.get('rol') == 'admin' %}
        <a href="{{ url_for('editar_horarios', clase_id=clase.id) }}" class="alert-link">Configurar horarios</a> para poder registrar asistencias.
        {% else %}
        Contacte al administrador para configurar los horarios de esta materia.
        {% endif %}
      </p>
    </div>
    {% endif %}
  </div>
</div>

<div class="row">
  <div class="col-md-6">
    <div class="card mb-3">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Estudiantes Asignados ({{ estudiantes_asignados|length }})</h5>
      </div>
      <div class="card-body">
        {% if estudiantes_asignados %}
        <div class="list-group">
          {% for estudiante in estudiantes_asignados %}
          <div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ estudiante.nombre }}</strong><br>
              <small class="text-muted">{{ estudiante.numero_control }}</small>
            </div>
            <form method="post" action="{{ url_for('remover_estudiante', clase_id=clase.id, estudiante_id=estudiante.id) }}" class="d-inline">
              <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Remover a {{ estudiante.nombre }} de esta materia?')">
                Remover
              </button>
            </form>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="text-muted">No hay estudiantes asignados a esta materia.</p>
        {% endif %}
      </div>
    </div>
  </div>
  
  <div class="col-md-6">
    {% if session.get('rol') == 'admin' %}
    <div class="card mb-3">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0">Asignar Estudiante</h5>
      </div>
      <div class="card-body">
        {% if estudiantes_no_asignados %}
        <form method="post" action="{{ url_for('asignar_estudiante', clase_id=clase.id) }}">
          <div class="mb-3">
            <label for="estudiante_id" class="form-label">Seleccionar Estudiante</label>
            <select class="form-select" id="estudiante_id" name="estudiante_id" required>
              <option value="">-- Seleccione un estudiante --</option>
              {% for estudiante in estudiantes_no_asignados %}
              <option value="{{ estudiante.id }}">{{ estudiante.nombre }} ({{ estudiante.numero_control }})</option>
              {% endfor %}
            </select>
          </div>
          <button type="submit" class="btn btn-success">Asignar Estudiante</button>
        </form>
        {% else %}
        <p class="text-muted">Todos los estudiantes ya están asignados a esta materia.</p>
        <a href="{{ url_for('nuevo_estudiante') }}" class="btn btn-outline-primary btn-sm">Registrar Nuevo Estudiante</a>
        {% endif %}
      </div>
    </div>
    {% endif %}
    
    {% if session.get('rol') == 'admin' %}
    <div class="card">
      <div class="card-header bg-danger text-white">
        <h5 class="mb-0">Zona de Peligro</h5>
      </div>
      <div class="card-body">
        <p class="text-muted">Eliminar esta materia eliminará todas las asistencias relacionadas.</p>
        <form method="post" action="{{ url_for('eliminar_materia', clase_id=clase.id) }}" onsubmit="return confirm('¿Está seguro de eliminar esta materia? Esta acción no se puede deshacer.');">
          <button type="submit" class="btn btn-danger">Eliminar Materia</button>
        </form>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Modal para Scanner QR -->
<div class="modal fade" id="scannerModal" tabindex="-1" aria-labelledby="scannerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="scannerModalLabel">
          <i class="bi bi-qr-code-scan"></i> Escanear QR - {{ clase.nombre_clase }}
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Información del horario actual -->
        {% set dias_nombres = {1: 'Lunes', 2: 'Martes', 3: 'Miércoles', 4: 'Jueves', 5: 'Viernes'} %}
        {% if horario_hoy %}
        <div class="alert alert-success mb-3">
          <i class="bi bi-clock"></i> <strong>Horario de clase ({{ dias_nombres[horario_hoy.dia_semana] }}):</strong> 
          {{ horario_hoy.hora_inicio.strftime('%H:%M') }} - {{ horario_hoy.hora_fin.strftime('%H:%M') }}
          <br>
          <i class="bi bi-clock-history"></i> <strong>Pase de lista:</strong> 
          {% if hora_minima_pase and hora_maxima_pase %}
          {{ hora_minima_pase.strftime('%H:%M') }} - {{ hora_maxima_pase.strftime('%H:%M') }}
          {% else %}
          {{ horario_hoy.hora_inicio.strftime('%H:%M') }} - {{ horario_hoy.hora_fin.strftime('%H:%M') }}
          {% endif %}
          <br><small class="text-muted">El pase de lista está disponible desde 15 minutos antes del inicio hasta 5 minutos después del inicio de clase.</small>
        </div>
        {% else %}
        <div class="alert alert-warning mb-3">
          <i class="bi bi-exclamation-triangle"></i> <strong>Advertencia:</strong> 
          No hay clase programada para hoy ({{ dias_nombres.get(dia_semana_actual, 'este día') }}). Solo se pueden registrar asistencias en los días y horarios configurados.
        </div>
        {% endif %}
        
        <div class="alert alert-info mb-3">
          <i class="bi bi-info-circle"></i> <strong>Instrucciones:</strong> Apunta la cámara del dispositivo al QR del estudiante para registrar su asistencia.
        </div>
        
        <div id="scanner-container" data-clase-id="{{ clase.id }}" style="width:100%;max-width:100%;margin:0 auto;min-height:400px;background-color:#000;border-radius:8px;overflow:hidden;position:relative;display:block;">
          <div id="scanner-loading" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;text-align:center;z-index:10;">
            <div class="spinner-border text-light" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Iniciando cámara...</p>
            <p id="loading-status" class="mt-2 small"></p>
          </div>
        </div>
        <script type="application/json" id="clase-data">{{ {'id': clase.id}|tojson }}</script>
        <script type="application/json" id="horario-data">{{ {
          'tieneHorario': horario_hoy is not none,
          'horarioInicio': horario_hoy.hora_inicio.strftime('%H:%M') if horario_hoy else None,
          'horarioFin': horario_hoy.hora_fin.strftime('%H:%M') if horario_hoy else None,
          'horaMinimaPase': hora_minima_pase.strftime('%H:%M') if hora_minima_pase else None,
          'horaMaximaPase': hora_maxima_pase.strftime('%H:%M') if hora_maxima_pase else None,
          'puedeRegistrar': puede_registrar
        }|tojson }}</script>
        <div id="scanner-resultado" class="mt-3" style="min-height: 80px;"></div>
        <div id="scanner-estado" class="mt-2 text-center text-muted fw-bold"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cerrarScanner">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Validación de horario para el botón de escanear QR
  (function() {
    const btnEscanearQR = document.getElementById('btnEscanearQR');
    const scannerModal = document.getElementById('scannerModal');
    
    // Datos del horario desde el servidor (cargados desde JSON)
    let horarioData = {
      tieneHorario: false,
      horarioInicio: null,
      horarioFin: null,
      puedeRegistrar: false
    };
    
    // Cargar datos del horario desde el elemento JSON
    const horarioDataEl = document.getElementById('horario-data');
    if (horarioDataEl) {
      try {
        horarioData = JSON.parse(horarioDataEl.textContent);
      } catch (e) {
        console.error('Error al parsear datos de horario:', e);
      }
    }
    
    function verificarHorario() {
      if (!horarioData.tieneHorario) {
        return false;
      }
      
      // Validar usando el rango de pase de lista: 15 min antes hasta 5 min después del inicio
      if (!horarioData.horaMinimaPase || !horarioData.horaMaximaPase) {
        return false;
      }
      
      const ahora = new Date();
      const horas = ahora.getHours().toString().padStart(2, '0');
      const minutos = ahora.getMinutes().toString().padStart(2, '0');
      const horaActual = horas + ':' + minutos;
      
      return horaActual >= horarioData.horaMinimaPase && horaActual <= horarioData.horaMaximaPase;
    }
    
    function obtenerMotivoBloqueo() {
      if (!horarioData.tieneHorario) {
        return 'No hay clase programada para hoy';
      }
      
      if (!horarioData.horaMinimaPase || !horarioData.horaMaximaPase) {
        return 'No hay horario de pase de lista configurado';
      }
      
      const ahora = new Date();
      const horas = ahora.getHours().toString().padStart(2, '0');
      const minutos = ahora.getMinutes().toString().padStart(2, '0');
      const horaActual = horas + ':' + minutos;
      
      if (horaActual < horarioData.horaMinimaPase) {
        return 'El pase de lista está disponible desde las ' + horarioData.horaMinimaPase + ' (15 min antes del inicio)';
      } else if (horaActual > horarioData.horaMaximaPase) {
        return 'El pase de lista cerró a las ' + horarioData.horaMaximaPase + ' (5 min después del inicio)';
      }
      return '';
    }
    
    function actualizarEstadoBoton() {
      if (!btnEscanearQR) return;
      
      const puedeRegistrar = verificarHorario();
      
      if (!puedeRegistrar) {
        btnEscanearQR.disabled = true;
        btnEscanearQR.classList.add('disabled');
        btnEscanearQR.title = obtenerMotivoBloqueo();
      } else {
        btnEscanearQR.disabled = false;
        btnEscanearQR.classList.remove('disabled');
        btnEscanearQR.title = '';
      }
    }
    
    // Prevenir que el modal se abra si está fuera del horario
    if (scannerModal && btnEscanearQR) {
      scannerModal.addEventListener('show.bs.modal', function(event) {
        if (!verificarHorario()) {
          event.preventDefault();
          event.stopPropagation();
          const motivo = obtenerMotivoBloqueo();
          alert('No se puede escanear QR fuera del horario de clase.\n\n' + motivo);
          return false;
        }
      });
    }
    
    // Verificar el horario cada minuto si hay horario configurado
    if (horarioData.tieneHorario) {
      actualizarEstadoBoton();
      setInterval(actualizarEstadoBoton, 60000); // Cada minuto
    }
  })();
  
  // Cargar la librería html5-qrcode primero con múltiples CDNs como fallback
  (function() {
    // Verificar si ya está cargado
    if (typeof Html5Qrcode !== 'undefined') {
      console.log('Html5Qrcode ya está disponible');
      inicializarScanner();
      return;
    }
    
    const cdnUrls = [
      'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js',
      'https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js'
    ];
    
    let currentIndex = 0;
    let scriptElement = null;
    
    function intentarCargar(index) {
      if (index >= cdnUrls.length) {
        console.error('Todos los CDNs fallaron');
        const resultDiv = document.getElementById('scanner-resultado');
        if (resultDiv) {
          resultDiv.innerHTML = `
            <div class="alert alert-danger">
              <strong>Error al cargar la librería de escaneo</strong><br>
              No se pudo cargar html5-qrcode desde ningún CDN disponible.<br>
              <small>Verifique su conexión a internet o contacte al administrador.</small><br><br>
              <button class="btn btn-sm btn-primary" onclick="location.reload()">Recargar página</button>
            </div>
          `;
        }
        return;
      }
      
      // Remover script anterior si existe
      if (scriptElement && scriptElement.parentNode) {
        scriptElement.parentNode.removeChild(scriptElement);
      }
      
      scriptElement = document.createElement('script');
      scriptElement.src = cdnUrls[index];
      scriptElement.async = true;
      scriptElement.crossOrigin = 'anonymous';
      
      scriptElement.onload = function() {
        console.log('html5-qrcode cargado correctamente desde:', cdnUrls[index]);
        // Esperar un momento para asegurar que la librería esté completamente inicializada
        setTimeout(function() {
          if (typeof Html5Qrcode !== 'undefined') {
            inicializarScanner();
          } else {
            console.warn('Html5Qrcode aún no está disponible después de cargar, intentando siguiente CDN...');
            currentIndex++;
            intentarCargar(currentIndex);
          }
        }, 100);
      };
      
      scriptElement.onerror = function() {
        console.warn('Error al cargar desde:', cdnUrls[index], 'Intentando siguiente CDN...');
        currentIndex++;
        intentarCargar(currentIndex);
      };
      
      document.head.appendChild(scriptElement);
    }
    
    // Esperar a que el DOM esté listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        intentarCargar(0);
      });
    } else {
      intentarCargar(0);
    }
  })();

  function inicializarScanner() {
    // Verificar que Html5Qrcode esté disponible
    if (typeof Html5Qrcode === 'undefined') {
      console.error('Html5Qrcode no está disponible');
      const resultDiv = document.getElementById('scanner-resultado');
      if (resultDiv) {
        resultDiv.innerHTML = `
          <div class="alert alert-danger">
            <strong>Error: Librería no disponible</strong><br>
            Html5Qrcode no se cargó correctamente. Recargue la página.
          </div>
        `;
      }
      return;
    }

    console.log('Html5Qrcode disponible, inicializando scanner...');

    const claseDataEl = document.getElementById('clase-data');
    if (!claseDataEl) {
      console.error('No se encontró el elemento clase-data');
      return;
    }

    const claseData = JSON.parse(claseDataEl.textContent);
    const claseId = claseData.id;
    let html5QrCode = null;
    let escaneando = false;
    const scannerContainer = document.getElementById('scanner-container');
    const resultDiv = document.getElementById('scanner-resultado');
    const estadoDiv = document.getElementById('scanner-estado');
    const scannerModal = document.getElementById('scannerModal');

    if (!scannerModal) {
      console.error('No se encontró el modal del scanner');
      return;
    }

    function mostrarEstado(mensaje, tipo = 'info') {
      estadoDiv.innerHTML = `<small class="text-${tipo}"><i class="bi bi-${tipo === 'success' ? 'check-circle' : tipo === 'danger' ? 'x-circle' : 'info-circle'}"></i> ${mensaje}</small>`;
    }

    function registrarEnServidor(payload) {
      if (escaneando) {
        console.log('Ya hay un registro en proceso, ignorando...');
        return;
      }
      escaneando = true;
      
      console.log('Registrando asistencia con payload:', payload);
      mostrarEstado('Registrando asistencia...', 'info');
      
      // Asegurar que resultDiv esté visible
      if (resultDiv) {
        resultDiv.style.display = 'block';
      }
      
      fetch('{{ url_for("registrar_asistencia") }}', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      })
      .then(r => {
        console.log('Respuesta del servidor - Status:', r.status);
        return r.json().then(j => ({status: r.status, body: j}));
      })
      .then(obj => {
        console.log('Respuesta completa:', obj);
        escaneando = false;
        
        if (obj.status === 200 && obj.body.ok) {
          console.log('Asistencia registrada exitosamente');
          if (resultDiv) {
            resultDiv.innerHTML = `
              <div class="alert alert-success alert-dismissible fade show d-block" role="alert" style="font-size: 1.1em;">
                <h5 class="alert-heading">
                  <i class="bi bi-check-circle-fill"></i> ${obj.body.msg || 'Asistencia registrada exitosamente'}
                </h5>
                <hr>
                <p class="mb-2">
                  <strong><i class="bi bi-person"></i> Estudiante:</strong> ${obj.body.estudiante || 'N/A'}<br>
                  <strong><i class="bi bi-clock"></i> Hora:</strong> ${obj.body.hora || ''}
                </p>
                <p class="mb-0"><small>Puede escanear otro código QR.</small></p>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
              </div>
            `;
            resultDiv.style.display = 'block';
            resultDiv.style.visibility = 'visible';
            resultDiv.style.opacity = '1';
            // Scroll suave hacia el mensaje
            setTimeout(() => {
              resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
          }
          mostrarEstado('✓ Escaneo completado. Puede escanear otro QR.', 'success');
          if (html5QrCode) {
            setTimeout(() => {
              html5QrCode.resume();
              mostrarEstado('Listo para escanear...', 'info');
            }, 3000);
          }
        } else if (obj.status === 409) {
          console.log('Asistencia ya registrada (409)');
          if (resultDiv) {
            resultDiv.innerHTML = `
              <div class="alert alert-warning alert-dismissible fade show d-block" role="alert" style="font-size: 1.1em;">
                <h5 class="alert-heading">
                  <i class="bi bi-exclamation-triangle-fill"></i> ${obj.body.msg || 'Asistencia ya registrada'}
                </h5>
                <hr>
                <p class="mb-2">
                  <strong><i class="bi bi-person"></i> Estudiante:</strong> ${obj.body.estudiante || 'N/A'}<br>
                  ${obj.body.hora ? `<strong><i class="bi bi-clock"></i> Registrado a las:</strong> ${obj.body.hora}` : ''}
                </p>
                <p class="mb-0"><small>Puede escanear otro código QR.</small></p>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
              </div>
            `;
            resultDiv.style.display = 'block';
            resultDiv.style.visibility = 'visible';
            resultDiv.style.opacity = '1';
            // Scroll suave hacia el mensaje
            setTimeout(() => {
              resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
          }
          mostrarEstado('⚠️ Ya registrado. Puede escanear otro QR.', 'warning');
          if (html5QrCode) {
            setTimeout(() => {
              html5QrCode.resume();
              mostrarEstado('Listo para escanear...', 'info');
            }, 3000);
          }
        } else if (obj.status === 403) {
          // Estudiante no asignado a la clase
          console.log('Estudiante no asignado a la clase (403)');
          if (resultDiv) {
            resultDiv.innerHTML = `
              <div class="alert alert-danger alert-dismissible fade show d-block" role="alert" style="font-size: 1.1em;">
                <h5 class="alert-heading">
                  <i class="bi bi-x-circle-fill"></i> Estudiante no asignado a esta materia
                </h5>
                <hr>
                <p class="mb-2">
                  <strong><i class="bi bi-person"></i> Estudiante:</strong> ${obj.body.estudiante || 'N/A'}<br>
                  <strong><i class="bi bi-123"></i> Número de Control:</strong> ${obj.body.numero_control || 'N/A'}<br>
                  <strong><i class="bi bi-book"></i> Materia:</strong> ${obj.body.clase || 'N/A'}
                </p>
                <p class="mb-0 text-danger">
                  <strong>⚠️ Este estudiante no está asignado a esta materia.</strong><br>
                  <small>Asigne el estudiante a la materia antes de registrar su asistencia.</small>
                </p>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
              </div>
            `;
            resultDiv.style.display = 'block';
            resultDiv.style.visibility = 'visible';
            resultDiv.style.opacity = '1';
            setTimeout(() => {
              resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
          }
          mostrarEstado('❌ Estudiante no asignado a esta materia.', 'danger');
          if (html5QrCode) {
            setTimeout(() => {
              html5QrCode.resume();
              mostrarEstado('Listo para escanear...', 'info');
            }, 3000);
          }
        } else if (obj.status === 400) {
          // Error de validación (fuera de horario, día sin clase, etc.)
          console.log('Error de validación (400):', obj.body.msg);
          if (resultDiv) {
            const esHorario = obj.body.msg && obj.body.msg.includes('horario');
            const esDia = obj.body.msg && obj.body.msg.includes('día');
            resultDiv.innerHTML = `
              <div class="alert alert-danger alert-dismissible fade show d-block" role="alert" style="font-size: 1.1em;">
                <h5 class="alert-heading">
                  <i class="bi bi-${esHorario || esDia ? 'clock' : 'x-circle'}-fill"></i> 
                  ${esHorario ? 'Fuera del Horario Permitido' : esDia ? 'Día sin Clase Programada' : 'Error al registrar asistencia'}
                </h5>
                <hr>
                <p class="mb-2">
                  ${obj.body.estudiante ? `<strong><i class="bi bi-person"></i> Estudiante:</strong> ${obj.body.estudiante}<br>` : ''}
                  ${obj.body.clase ? `<strong><i class="bi bi-book"></i> Materia:</strong> ${obj.body.clase}<br>` : ''}
                  ${obj.body.horario ? `<strong><i class="bi bi-clock"></i> Horario permitido:</strong> ${obj.body.horario}<br>` : ''}
                </p>
                <p class="mb-0 text-danger">
                  <strong>⚠️ ${obj.body.msg || 'No se puede registrar la asistencia en este momento.'}</strong>
                </p>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
              </div>
            `;
            resultDiv.style.display = 'block';
            resultDiv.style.visibility = 'visible';
            resultDiv.style.opacity = '1';
            setTimeout(() => {
              resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
          }
          mostrarEstado('❌ ' + (obj.body.msg || 'Error de validación'), 'danger');
          if (html5QrCode) {
            setTimeout(() => {
              html5QrCode.resume();
              mostrarEstado('Listo para escanear...', 'info');
            }, 4000);
          }
        } else {
          console.log('Error al registrar - Status:', obj.status, 'Mensaje:', obj.body.msg);
          if (resultDiv) {
            resultDiv.innerHTML = `
              <div class="alert alert-danger alert-dismissible fade show d-block" role="alert" style="font-size: 1.1em;">
                <h5 class="alert-heading">
                  <i class="bi bi-x-circle-fill"></i> ${obj.body.msg || 'Error al registrar asistencia'}
                </h5>
                ${obj.body.estudiante ? `<hr><p class="mb-0"><strong>Estudiante:</strong> ${obj.body.estudiante}</p>` : ''}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
              </div>
            `;
            resultDiv.style.display = 'block';
            resultDiv.style.visibility = 'visible';
            resultDiv.style.opacity = '1';
            setTimeout(() => {
              resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
          }
          mostrarEstado('Error. Puede intentar de nuevo.', 'danger');
          if (html5QrCode) {
            setTimeout(() => {
              html5QrCode.resume();
              mostrarEstado('Listo para escanear...', 'info');
            }, 3000);
          }
        }
      })
      .catch(err => {
        escaneando = false;
        console.error('Error en fetch:', err);
        if (resultDiv) {
          resultDiv.innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <strong><i class="bi bi-wifi-off"></i> Error de conexión</strong><br>
              No se pudo conectar con el servidor. Verifique su conexión a internet.
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          `;
          resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        mostrarEstado('Error de conexión. Verifique su internet.', 'danger');
        if (html5QrCode) {
          setTimeout(() => {
            html5QrCode.resume();
            mostrarEstado('Listo para escanear...', 'info');
          }, 2000);
        }
      });
    }

    function parsePayload(text) {
      try {
        const parsed = JSON.parse(text);
        if (parsed && parsed.numero_control) {
          return parsed;
        }
      } catch(e) {
        console.log('No es JSON válido, intentando como texto plano');
      }
      return null;
    }

    function actualizarLoadingStatus(mensaje) {
      const statusEl = document.getElementById('loading-status');
      if (statusEl) {
        statusEl.textContent = mensaje;
      }
      console.log('Loading status:', mensaje);
    }

    function iniciarScanner() {
      // Limpiar cualquier scanner anterior
      if (html5QrCode) {
        console.log('Deteniendo scanner anterior...');
        html5QrCode.stop().then(() => {
          html5QrCode.clear();
          html5QrCode = null;
        }).catch(() => {
          html5QrCode = null;
        });
      }

      const container = document.getElementById('scanner-container');
      if (!container) {
        console.error('Contenedor del scanner no encontrado');
        return;
      }

      const loadingDiv = document.getElementById('scanner-loading');
      if (loadingDiv) {
        loadingDiv.style.display = 'block';
      }
      actualizarLoadingStatus('Preparando scanner...');
      
      // Detectar iOS/Safari
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      
      console.log('Dispositivo iOS:', isIOS);
      console.log('Protocolo:', window.location.protocol);
      console.log('Hostname:', window.location.hostname);
      
      // Verificar HTTPS (requerido en iOS excepto localhost)
      const isSecure = window.location.protocol === 'https:' || 
                       window.location.hostname === 'localhost' || 
                       window.location.hostname === '127.0.0.1';
      
      if (isIOS && !isSecure) {
        if (loadingDiv) loadingDiv.style.display = 'none';
        resultDiv.innerHTML = `
          <div class="alert alert-warning">
            <strong><i class="bi bi-exclamation-triangle"></i> HTTPS requerido en iOS</strong><br>
            Safari en iPhone requiere HTTPS para acceder a la cámara (excepto localhost).<br>
            <small>Acceda a través de HTTPS o use localhost en su computadora.</small>
          </div>
        `;
        mostrarEstado('HTTPS requerido en iOS', 'warning');
        return;
      }
      
      // Esperar a que el modal esté completamente visible y el contenedor tenga dimensiones
      function verificarDimensiones() {
        const rect = container.getBoundingClientRect();
        console.log('Dimensiones del contenedor:', rect.width, 'x', rect.height);
        
        if (rect.width === 0 || rect.height === 0) {
          console.log('Contenedor aún sin dimensiones, reintentando...');
          return false;
        }
        return true;
      }

      // Intentar hasta 10 veces con delay de 200ms
      let intentos = 0;
      const verificarInterval = setInterval(() => {
        intentos++;
        if (verificarDimensiones() || intentos >= 10) {
          clearInterval(verificarInterval);
          if (intentos >= 10 && !verificarDimensiones()) {
            console.error('Contenedor no tiene dimensiones válidas después de 2 segundos');
            actualizarLoadingStatus('Error: Contenedor sin dimensiones');
            if (loadingDiv) loadingDiv.style.display = 'none';
            resultDiv.innerHTML = `
              <div class="alert alert-danger">
                <strong>Error al inicializar scanner</strong><br>
                El contenedor no tiene dimensiones válidas. Intente cerrar y abrir el modal nuevamente.
              </div>
            `;
            return;
          }
          iniciarCamara();
        }
      }, 200);

      function iniciarCamara() {
        try {
          html5QrCode = new Html5Qrcode("scanner-container");
        } catch (err) {
          console.error('Error al crear Html5Qrcode:', err);
          if (loadingDiv) loadingDiv.style.display = 'none';
          resultDiv.innerHTML = `
            <div class="alert alert-danger">
              <strong>Error al inicializar scanner</strong><br>
              ${err.message || 'Error desconocido'}
            </div>
          `;
          return;
        }
        
        // Configuración simplificada
        const qrConfig = { 
          fps: isIOS ? 5 : 40,
          qrbox: { width: 550, height: 550 },
          aspectRatio: 1.0
        };

        mostrarEstado('Solicitando acceso a la cámara...', 'info');
        actualizarLoadingStatus('Obteniendo acceso a la cámara...');

        // Intentar obtener cámaras primero
        Html5Qrcode.getCameras().then(cameras => {
          console.log('Cámaras encontradas:', cameras.length);
          actualizarLoadingStatus(`Cámaras encontradas: ${cameras.length}`);
          
          if (!cameras || cameras.length === 0) {
            if (loadingDiv) loadingDiv.style.display = 'none';
            resultDiv.innerHTML = `
              <div class="alert alert-danger">
                <i class="bi bi-camera-video-off"></i> <strong>No se detectó ninguna cámara</strong><br>
                <small>Verifique que su dispositivo tenga una cámara disponible y que el navegador tenga permisos para acceder a ella.</small>
              </div>
            `;
            mostrarEstado('Cámara no disponible', 'danger');
            return;
          }

          // Seleccionar cámara trasera si está disponible
          let cameraId = null;
          console.log('Cámaras disponibles:');
          cameras.forEach((cam, index) => {
            console.log(`  ${index}: ${cam.label || cam.id} (ID: ${cam.id})`);
          });
          
          // Buscar cámara trasera
          for (let cam of cameras) {
            const label = (cam.label || '').toLowerCase();
            if (label.includes('back') || label.includes('rear') || label.includes('environment')) {
              cameraId = cam.id;
              console.log('Cámara trasera encontrada:', cam.label || cam.id);
              break;
            }
          }
          
          // Si no encuentra trasera, intentar usar la última cámara (generalmente es la trasera)
          if (!cameraId && cameras.length > 1) {
            cameraId = cameras[cameras.length - 1].id;
            console.log('Usando última cámara disponible (probablemente trasera):', cameras[cameras.length - 1].label || cameraId);
          }
          
          // Si aún no hay cámara, usar la primera disponible
          if (!cameraId) {
            cameraId = cameras[0].id;
            console.log('Usando primera cámara disponible:', cameras[0].label || cameraId);
          }

          actualizarLoadingStatus('Iniciando cámara...');
          mostrarEstado('Iniciando cámara...', 'info');
          console.log('Cámara seleccionada ID:', cameraId);

          html5QrCode.start(
            cameraId,
            qrConfig,
            (decodedText, decodedResult) => {
              console.log('QR detectado:', decodedText);
              if (html5QrCode) {
                html5QrCode.pause();
              }
              mostrarEstado('QR detectado, procesando...', 'info');
              
              let payload = parsePayload(decodedText);
              
              if (payload && payload.numero_control) {
                payload.clase_id = claseId;
                registrarEnServidor(payload);
              } else {
                const numeroControl = decodedText.trim();
                if (numeroControl.length >= 3 && /^[a-zA-Z0-9_-]+$/.test(numeroControl)) {
                  registrarEnServidor({
                    numero_control: numeroControl,
                    clase_id: claseId
                  });
                } else {
                  escaneando = false;
                  resultDiv.innerHTML = `
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                      <strong><i class="bi bi-exclamation-triangle"></i> QR no válido</strong><br>
                      El código QR escaneado no contiene un número de control válido.
                      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                  `;
                  mostrarEstado('QR inválido. Intente con otro código.', 'warning');
                  if (html5QrCode) {
                    setTimeout(() => {
                      html5QrCode.resume();
                      mostrarEstado('Listo para escanear...', 'info');
                    }, 2000);
                  }
                }
              }
            },
            (errorMessage) => {
              // Errores de decodificación son normales, ignorar
            }
          ).then(() => {
            console.log('Cámara iniciada exitosamente');
            if (loadingDiv) loadingDiv.style.display = 'none';
            mostrarEstado('Cámara activa. Apunta al código QR del estudiante.', 'success');
          }).catch(err => {
            console.error('Error al iniciar cámara:', err);
            console.error('Cámara ID que falló:', cameraId);
            console.error('Todas las cámaras disponibles:', cameras.map(c => ({id: c.id, label: c.label})));
            if (loadingDiv) loadingDiv.style.display = 'none';
            const errorMsg = err.message || err.toString() || 'Error desconocido';
            console.error('Detalles del error:', err);
            
            // Si falla con la cámara trasera, intentar con la primera disponible
            if (cameras.length > 1 && cameraId !== cameras[0].id) {
              console.log('Intentando con la primera cámara disponible como fallback...');
              mostrarEstado('Reintentando con otra cámara...', 'info');
              actualizarLoadingStatus('Reintentando con otra cámara...');
              
              html5QrCode.start(
                cameras[0].id,
                qrConfig,
                (decodedText, decodedResult) => {
                  console.log('QR detectado:', decodedText);
                  if (html5QrCode) {
                    html5QrCode.pause();
                  }
                  mostrarEstado('QR detectado, procesando...', 'info');
                  
                  let payload = parsePayload(decodedText);
                  
                  if (payload && payload.numero_control) {
                    payload.clase_id = claseId;
                    registrarEnServidor(payload);
                  } else {
                    const numeroControl = decodedText.trim();
                    if (numeroControl.length >= 3 && /^[a-zA-Z0-9_-]+$/.test(numeroControl)) {
                      registrarEnServidor({
                        numero_control: numeroControl,
                        clase_id: claseId
                      });
                    } else {
                      escaneando = false;
                      resultDiv.innerHTML = `
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                          <strong><i class="bi bi-exclamation-triangle"></i> QR no válido</strong><br>
                          El código QR escaneado no contiene un número de control válido.
                          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                      `;
                      mostrarEstado('QR inválido. Intente con otro código.', 'warning');
                      if (html5QrCode) {
                        setTimeout(() => {
                          html5QrCode.resume();
                          mostrarEstado('Listo para escanear...', 'info');
                        }, 2000);
                      }
                    }
                  }
                },
                (errorMessage) => {
                  // Errores de decodificación son normales, ignorar
                }
              ).then(() => {
                console.log('Cámara alternativa iniciada exitosamente');
                if (loadingDiv) loadingDiv.style.display = 'none';
                mostrarEstado('Cámara activa. Apunta al código QR del estudiante.', 'success');
              }).catch(err2 => {
                console.error('Error también con cámara alternativa:', err2);
                // Mostrar error final
                const errorMsg2 = err2.message || err2.toString() || 'Error desconocido';
                let mensajeError = errorMsg2;
                if (errorMsg2.includes('Permission denied') || errorMsg2.includes('NotAllowedError')) {
                  mensajeError = 'Permisos de cámara denegados. Por favor, permita el acceso a la cámara en la configuración del navegador.';
                } else if (errorMsg2.includes('NotFoundError') || errorMsg2.includes('No camera')) {
                  mensajeError = 'No se encontró ninguna cámara disponible.';
                } else if (errorMsg2.includes('NotReadableError')) {
                  mensajeError = 'La cámara está siendo usada por otra aplicación. Cierre otras aplicaciones que puedan estar usando la cámara.';
                }
                
                resultDiv.innerHTML = `
                  <div class="alert alert-danger">
                    <strong><i class="bi bi-exclamation-triangle"></i> Error al iniciar cámara</strong><br>
                    ${mensajeError}<br>
                    <small>Error técnico: ${errorMsg2}</small>
                  </div>
                `;
                mostrarEstado('Error al iniciar cámara', 'danger');
              });
              return; // Salir del catch para evitar ejecutar el código de error siguiente
            }
            
            // Manejo de error si no hay fallback o falló el fallback
            let mensajeError = errorMsg;
            if (errorMsg.includes('Permission denied') || errorMsg.includes('NotAllowedError')) {
              mensajeError = 'Permisos de cámara denegados. Por favor, permita el acceso a la cámara en la configuración del navegador.';
            } else if (errorMsg.includes('NotFoundError') || errorMsg.includes('No camera')) {
              mensajeError = 'No se encontró ninguna cámara disponible.';
            } else if (errorMsg.includes('NotReadableError')) {
              mensajeError = 'La cámara está siendo usada por otra aplicación. Cierre otras aplicaciones que puedan estar usando la cámara.';
            }
            
            resultDiv.innerHTML = `
              <div class="alert alert-danger">
                <strong><i class="bi bi-exclamation-triangle"></i> Error al iniciar la cámara</strong><br>
                ${mensajeError}<br><br>
                <strong>Soluciones:</strong>
                <ul class="text-start small">
                  <li>Verifique que el navegador tenga permisos de cámara</li>
                  <li>Cierre otras aplicaciones que puedan estar usando la cámara</li>
                  <li>Recargue la página e intente nuevamente</li>
                  ${isIOS ? '<li><strong>En iPhone: Asegúrese de estar usando HTTPS</strong></li>' : ''}
                </ul>
                <button class="btn btn-sm btn-primary mt-2" onclick="iniciarScanner()">Reintentar</button>
                <button class="btn btn-sm btn-secondary mt-2" onclick="location.reload()">Recargar página</button>
              </div>
            `;
            mostrarEstado('Error: ' + mensajeError, 'danger');
            html5QrCode = null;
          });
        }).catch(err => {
          console.error('Error al obtener cámaras:', err);
          if (loadingDiv) loadingDiv.style.display = 'none';
          const errorMsg = err.message || err.toString() || 'Error desconocido';
          
          let mensajeError = errorMsg;
          if (errorMsg.includes('Permission denied') || errorMsg.includes('NotAllowedError')) {
            mensajeError = 'Permisos de cámara denegados. Por favor, permita el acceso a la cámara.';
          }
          
          resultDiv.innerHTML = `
            <div class="alert alert-danger">
              <strong><i class="bi bi-exclamation-triangle"></i> Error al acceder a las cámaras</strong><br>
              ${mensajeError}<br><br>
              <strong>Soluciones:</strong>
              <ul class="text-start small">
                <li>Verifique los permisos de cámara en su dispositivo</li>
                <li>Asegúrese de permitir el acceso cuando el navegador lo solicite</li>
                <li>Cierre otras aplicaciones que puedan estar usando la cámara</li>
                ${isIOS ? '<li><strong>En iPhone: Use HTTPS o acceda desde localhost</strong></li>' : '<li>Verifique que esté usando HTTPS o localhost</li>'}
              </ul>
              <button class="btn btn-sm btn-primary mt-2" onclick="iniciarScanner()">Reintentar</button>
              <button class="btn btn-sm btn-secondary mt-2" onclick="location.reload()">Recargar página</button>
            </div>
          `;
          mostrarEstado('Error de permisos: ' + mensajeError, 'danger');
        });
    }
  }

    function detenerScanner() {
      if (html5QrCode) {
        console.log('Deteniendo scanner...');
        html5QrCode.stop().then(() => {
          html5QrCode.clear();
          html5QrCode = null;
          resultDiv.innerHTML = '';
          estadoDiv.innerHTML = '';
          escaneando = false;
          const loadingDiv = document.getElementById('scanner-loading');
          if (loadingDiv) loadingDiv.style.display = 'block';
          console.log('Scanner detenido correctamente');
        }).catch(err => {
          console.error('Error al detener scanner:', err);
          html5QrCode = null;
        });
      }
    }

    // Iniciar scanner cuando se abre el modal
    scannerModal.addEventListener('shown.bs.modal', function () {
      // Iniciar inmediatamente cuando el modal esté visible
      console.log('Modal completamente visible, iniciando scanner...');
      iniciarScanner();
    });

    // Detener scanner cuando se cierra el modal
    scannerModal.addEventListener('hidden.bs.modal', function () {
      detenerScanner();
    });

    // También detener al hacer clic en cerrar
    const cerrarBtn = document.getElementById('cerrarScanner');
    if (cerrarBtn) {
      cerrarBtn.addEventListener('click', function() {
        detenerScanner();
      });
    }

    // Hacer las funciones accesibles globalmente para los botones de reintentar
    window.iniciarScanner = iniciarScanner;
  }
</script>
{% endblock %}


